{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Shipments</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addShipmentModal">
            <i class="fas fa-plus"></i> Add New Shipment
        </button>
    </div>
    
    <!-- Add Shipment Modal -->
    <div class="modal fade" id="addShipmentModal" tabindex="-1" aria-labelledby="addShipmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addShipmentModalLabel">Add New Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addShipmentForm">
                        <div class="mb-3">
                            <label for="shipmentId" class="form-label">Shipment ID</label>
                            <input type="text" class="form-control" id="shipmentId" required>
                            <div id="shipmentIdFeedback" class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="shipmentCenter" class="form-label">Shipment Center</label>
                            <select class="form-select" id="shipmentCenter" required>
                                <option value="">Select Center</option>
                                <option value="Warehouse 1">Warehouse 1</option>
                                <option value="Warehouse 2">Warehouse 2</option>
                                <option value="Warehouse 3">Warehouse 3</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="shipmentStatus" class="form-label">Shipment Status</label>
                            <select class="form-select" id="shipmentStatus" required>
                                <option value="">Select Status</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Pending">Pending</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="employeeId" class="form-label">Employee ID</label>
                            <input type="text" class="form-control" id="employeeId" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitShipment">Add Shipment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="text" id="shipmentIdSearch" class="form-control" placeholder="Search by Shipment ID...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="text" id="centerSearch" class="form-control" placeholder="Search by Center...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Pending">Pending</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="text" id="employeeSearch" class="form-control" placeholder="Search by Employee ID...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shipments Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th>Shipment ID</th>
                            <th>Shipment Center</th>
                            <th>Shipment Status</th>
                            <th>Employee ID</th>
                        </tr>
                    </thead>
                    <tbody id="shipmentsTableBody">
                        {% for shipment in shipments %}
                        <tr>
                            <td>
                                <div class="editable-field">
                                    <span class="shipment-id">{{ shipment.Shipment_ID }}</span>
                                    <button class="btn btn-sm btn-light edit-btn ms-2">
                                        <i class="fas fa-edit text-secondary"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="center-badge dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            data-shipment-id="{{ shipment.Shipment_ID }}">
                                        {{ shipment.Shipment_Center }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 1">Warehouse 1</a></li>
                                        <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 2">Warehouse 2</a></li>
                                        <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 3">Warehouse 3</a></li>
                                    </ul>
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="status-badge dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            data-shipment-id="{{ shipment.Shipment_ID }}">
                                        {{ shipment.Shipment_Status }}
                                        {% if shipment.Shipment_Status == 'Delivered' %}
                                            <i class="fas fa-check-circle ms-1"></i>
                                        {% endif %}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item status-option" href="#" data-status="Shipped">Shipped</a></li>
                                        <li><a class="dropdown-item status-option" href="#" data-status="Pending">Pending</a></li>
                                        <li><a class="dropdown-item status-option" href="#" data-status="Delivered">Delivered <i class="fas fa-check-circle ms-1"></i></a></li>
                                    </ul>
                                </div>
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="employee-badge dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            data-shipment-id="{{ shipment.Shipment_ID }}">
                                        {{ shipment.Employee_ID }}
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% for employee in employees %}
                                        <li><a class="dropdown-item employee-option" href="#" data-employee="{{ employee.Employee_ID }}">{{ employee.Employee_ID }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.status-badge {
    border: none;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-badge[data-status="Shipped"],
.dropdown-item[data-status="Shipped"] {
    background-color: #0d6efd;
    color: white;
}

.status-badge[data-status="Pending"],
.dropdown-item[data-status="Pending"] {
    background-color: #dc3545;
    color: white;
}

.status-badge[data-status="Delivered"],
.dropdown-item[data-status="Delivered"] {
    background-color: #28a745;
    color: white;
}

.center-badge {
    border: none;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #ffd700;
    color: black;
}

.employee-badge {
    border: none;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #e9ecef;
    color: #495057;
}

.employee-badge:hover {
    background-color: #dee2e6;
}

.editable-field {
    display: flex;
    align-items: center;
}

.edit-btn {
    padding: 2px 8px;
    font-size: 0.8rem;
    background-color: transparent;
    border: none;
    opacity: 0.5;
}

.edit-btn:hover {
    opacity: 1;
    background-color: #f8f9fa;
}

.editable-field:hover .edit-btn {
    opacity: 0.8;
}

.editing {
    display: flex;
    gap: 5px;
}

.editing input {
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid #ced4da;
}

.save-btn, .cancel-btn {
    padding: 2px 8px;
    font-size: 0.8rem;
}

.input-group {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.input-group .form-control:focus {
    border-color: #ffd700;
    box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
}

.input-group .btn-warning {
    background-color: #ffd700;
    border-color: #ffd700;
    color: #000;
}

.input-group .btn-warning:hover {
    background-color: #e6c200;
    border-color: #e6c200;
}

#filterStatus {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#filterStatus:focus {
    border-color: #ffd700;
    box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusBadges = document.querySelectorAll('.status-badge');
    
    statusBadges.forEach(badge => {
        // Set initial status
        const currentStatus = badge.textContent.trim();
        badge.setAttribute('data-status', currentStatus);
        
        // Find all status options in this badge's dropdown
        const dropdownItems = badge.nextElementSibling.querySelectorAll('.status-option');
        
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.getAttribute('data-status');
                const shipmentId = badge.getAttribute('data-shipment-id');
                
                // Send update to server
                fetch('/update_shipment_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `shipment_id=${shipmentId}&status=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update badge text and status
                        badge.innerHTML = newStatus;
                        badge.setAttribute('data-status', newStatus);
                        
                        // Add check icon if status is Delivered
                        if (newStatus === 'Delivered') {
                            const checkIcon = document.createElement('i');
                            checkIcon.className = 'fas fa-check-circle ms-1';
                            badge.appendChild(checkIcon);
                        }
                        
                        // Show success message
                        alert('Status Updated');
                    } else {
                        // Show error message
                        alert(data.message || 'Failed to update status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update status. Please try again.');
                });
            });
        });
    });

    // Get search inputs
    const shipmentIdSearch = document.getElementById('shipmentIdSearch');
    const centerSearch = document.getElementById('centerSearch');
    const filterStatus = document.getElementById('filterStatus');
    const employeeSearch = document.getElementById('employeeSearch');
    const tableBody = document.getElementById('shipmentsTableBody');

    function filterTable() {
        const rows = tableBody.getElementsByTagName('tr');
        const shipmentFilter = shipmentIdSearch.value.toLowerCase();
        const centerFilter = centerSearch.value.toLowerCase();
        const statusFilter = filterStatus.value.toLowerCase();
        const employeeFilter = employeeSearch.value.toLowerCase();

        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            const shipmentId = cells[0].textContent.toLowerCase();
            const center = cells[1].textContent.toLowerCase();
            const status = cells[2].querySelector('.status-badge').textContent.trim().toLowerCase();
            const employeeId = cells[3].querySelector('.employee-badge').textContent.toLowerCase();

            const matchShipment = shipmentId.includes(shipmentFilter);
            const matchCenter = center.includes(centerFilter);
            const matchStatus = !statusFilter || status.includes(statusFilter);
            const matchEmployee = employeeId.includes(employeeFilter);

            row.style.display = (matchShipment && matchCenter && matchStatus && matchEmployee) ? '' : 'none';
        }
    }

    // Add event listeners
    shipmentIdSearch.addEventListener('input', filterTable);
    centerSearch.addEventListener('input', filterTable);
    filterStatus.addEventListener('change', filterTable);
    employeeSearch.addEventListener('input', filterTable);

    // Handle Shipment ID editing
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.closest('.editable-field');
            const span = container.querySelector('.shipment-id');
            const currentValue = span.textContent;

            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'editing';
            editForm.innerHTML = `
                <input type="text" value="${currentValue}" class="form-control form-control-sm">
                <button class="btn btn-sm btn-success save-btn"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-danger cancel-btn"><i class="fas fa-times"></i></button>
            `;

            // Hide current display
            span.style.display = 'none';
            this.style.display = 'none';

            // Show edit form
            container.appendChild(editForm);

            // Handle save
            editForm.querySelector('.save-btn').addEventListener('click', function() {
                const newValue = editForm.querySelector('input').value;
                updateShipmentId(currentValue, newValue, container, span, editForm);
            });

            // Handle cancel
            editForm.querySelector('.cancel-btn').addEventListener('click', function() {
                span.style.display = '';
                btn.style.display = '';
                container.removeChild(editForm);
            });
        });
    });

    // Handle Shipment Center changes
    document.querySelectorAll('.center-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const shipmentId = this.closest('.dropdown').querySelector('.center-badge').dataset.shipmentId;
            const newCenter = this.dataset.center;
            updateShipmentCenter(shipmentId, newCenter, this);
        });
    });

    // Handle Employee ID changes
    document.querySelectorAll('.employee-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const shipmentId = this.closest('.dropdown').querySelector('.employee-badge').dataset.shipmentId;
            const newEmployee = this.dataset.employee;
            updateShipmentEmployee(shipmentId, newEmployee, this);
        });
    });

    // Add event listener for add shipment button
    document.getElementById('submitShipment').addEventListener('click', function() {
        const shipmentId = document.getElementById('shipmentId').value;
        const shipmentCenter = document.getElementById('shipmentCenter').value;
        const shipmentStatus = document.getElementById('shipmentStatus').value;
        const employeeId = document.getElementById('employeeId').value;

        // Validate input
        if (!shipmentId.trim() || !shipmentCenter.trim() || !shipmentStatus.trim() || !employeeId.trim()) {
            alert('Please fill in all fields');
            return;
        }

        // Send request to add shipment
        fetch('/add_shipment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'shipment_id': shipmentId,
                'shipment_center': shipmentCenter,
                'shipment_status': shipmentStatus,
                'employee_id': employeeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = document.getElementById('addShipmentModal');
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');

                // Clear input fields
                document.getElementById('shipmentId').value = '';
                document.getElementById('shipmentCenter').value = '';
                document.getElementById('shipmentStatus').value = '';
                document.getElementById('employeeId').value = '';

                // Add new shipment to table
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>
                        <div class="editable-field">
                            <span class="shipment-id">${shipmentId}</span>
                            <button class="btn btn-sm btn-light edit-btn ms-2">
                                <i class="fas fa-edit text-secondary"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="center-badge dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    data-shipment-id="${shipmentId}">
                                ${shipmentCenter}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 1">Warehouse 1</a></li>
                                <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 2">Warehouse 2</a></li>
                                <li><a class="dropdown-item center-option" href="#" data-center="Warehouse 3">Warehouse 3</a></li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="status-badge dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    data-shipment-id="${shipmentId}">
                                ${shipmentStatus}
                                {% if shipmentStatus == 'Delivered' %}
                                    <i class="fas fa-check-circle ms-1"></i>
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item status-option" href="#" data-status="Shipped">Shipped</a></li>
                                <li><a class="dropdown-item status-option" href="#" data-status="Pending">Pending</a></li>
                                <li><a class="dropdown-item status-option" href="#" data-status="Delivered">Delivered <i class="fas fa-check-circle ms-1"></i></a></li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="employee-badge dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    data-shipment-id="${shipmentId}">
                                ${employeeId}
                            </button>
                            <ul class="dropdown-menu">
                                {% for employee in employees %}
                                <li><a class="dropdown-item employee-option" href="#" data-employee="${employee.Employee_ID}">${employee.Employee_ID}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </td>
                `;
                tableBody.appendChild(newRow);

                alert('Shipment added successfully');
            } else {
                alert(data.message || 'Failed to add shipment');
            }
        })
        .catch(error => {
            alert('Failed to add shipment');
        });
    });

    function updateShipmentId(oldId, newId, container, span, editForm) {
        // First validate the input
        if (!newId.trim()) {
            alert('Shipment ID cannot be empty');
            return;
        }

        fetch('/update_shipment_id', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                old_id: oldId,
                new_id: newId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                span.textContent = newId;
                span.style.display = '';
                container.querySelector('.edit-btn').style.display = '';
                container.removeChild(editForm);
                alert('Shipment ID has been updated successfully.');
            } else {
                // Show error message and keep the edit form open
                alert(data.message || 'Failed to update shipment ID');
                // Focus back on the input field
                editForm.querySelector('input').focus();
            }
        })
        .catch(error => {
            alert('Failed to update shipment ID');
            // Focus back on the input field
            editForm.querySelector('input').focus();
        });
    }

    function updateShipmentCenter(shipmentId, newCenter, element) {
        fetch('/update_shipment_center', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                shipment_id: shipmentId,
                new_center: newCenter
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const button = element.closest('.dropdown').querySelector('.center-badge');
                button.textContent = newCenter;
                alert('Shipment center has been updated successfully.');
            } else {
                alert(data.message || 'Failed to update shipment center');
            }
        })
        .catch(error => {
            alert('Failed to update shipment center');
        });
    }

    function updateShipmentEmployee(shipmentId, newEmployee, element) {
        fetch('/update_shipment_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                shipment_id: shipmentId,
                new_employee: newEmployee
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const button = element.closest('.dropdown').querySelector('.employee-badge');
                button.textContent = newEmployee;
                alert('Employee has been updated successfully.');
            } else {
                alert(data.message || 'Failed to update employee');
            }
        })
        .catch(error => {
            alert('Failed to update employee');
        });
    }
});
</script>

{% endblock %}
